<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ER HR Dashboard - Simpal HRMS</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/6SF5KQG.png">
  <link rel="stylesheet" href="er-styles.css">

</head>

<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-circle"><img src="https://i.imgur.com/6SF5KQG.png" alt="logo"></div>
    <h2>Employee Relations Dashboard</h2>
    <nav class="nav">
      <button id="burgerBtn" class="burger-btn">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <button class="tab-btn active" data-tab="caseTab">Cases</button>
      <button class="tab-btn" data-tab="databaseTab">Database</button>
      <button class="tab-btn" data-tab="reportsTab">Reports</button>

    </nav>
    <button id="logoutBtn">Logout</button>
  </aside>

  <!-- Loader overlay -->
  <div class="loader-overlay" id="loader" aria-hidden="true">
    <div class="spinner" role="status" aria-hidden="true"></div>
    <p id="loaderTxt">Loading...</p>
  </div>

  <!-- Main -->
  <div class="main" role="main">
    <h1></h1>

    <!-- Cases -->
    <div id="caseTab" class="tab-content active">
      <h2>Case Management</h2>
      <form id="caseForm">
        <input id="case_area" placeholder="Area" required>
        <input id="case_name" placeholder="Case" required>
        <input id="case_employees" placeholder="Employee(s) Involved" required>
        <input id="case_officer" placeholder="Grievance Officer" required>
        <textarea id="case_notes" placeholder="Notes or case description"></textarea>
        <input type="file" id="case_file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" />
        <button type="submit">Add Case</button>
      </form>
      <table>
        <thead>
          <tr>
            <th>Transcode</th>
            <th>Case Name</th>
            <th>Area of Designation</th>
            <th>Status</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="caseTbody"></tbody>
      </table>
    </div>


    <div id="databaseTab" class="tab-content">
      <h2>Employee Database</h2>
      <div class="emp-table-actions">
        <input id="empSearch" class="search-input" placeholder="Search name, position, email or mobile...">
        <div style="color:#9b9b9b;font-size:13px;" id="empCount">Records loaded.</div>
      </div>
      <div class="emp-table-container">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Position</th>
              <th>Email</th>
              <th>Mobile</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="dbTbody"></tbody>
        </table>
      </div>
    </div>


    <div id="filesTab" class="tab-content">
      <h2>Uploaded Files (employee_201files)</h2>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div class="muted" id="filesCount">Loading files...</div>
        <div>
          <input id="fileSearch" class="search-input" placeholder="Search file name...">
        </div>
      </div>

      <div id="filesGrid" class="files-grid"></div>
    </div>


    <div id="reportsTab" class="tab-content">
      <h2>Employee Reports</h2>
      <p style="text-align:center;color:#999;">Feature coming soon...</p>
    </div>

    <div class="watermark">Designed & Developed By : Edwin Angelo Catequista</div>
  </div>


  <div id="caseModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="caseModalTitle">
      <span class="closeBtn" id="closeCaseModal">&times;</span>
      <h2 id="caseModalTitle">Case Details</h2>

      <div id="caseDetailsContainer">
        <div class="info">
          <div class="label">Case</div>
          <div class="value" id="detail_case_name"></div>
        </div>
        <div class="info">
          <div class="label">Area</div>
          <div class="value" id="detail_area"></div>
        </div>
        <div class="info">
          <div class="label">Employees</div>
          <div class="value" id="detail_employees"></div>
        </div>
        <div class="info">
          <div class="label">Officer</div>
          <div class="value" id="detail_officer"></div>
        </div>

        <div class="info">
          <div class="label">STATUS</div>
          <div class="value">
            <select id="detail_STATUS">
              <option value="OPEN">IR</option>
              <option value="OPEN">OPEN</option>
              <option value="NTE">NTE</option>
              <option value="AH">AH</option>
              <option value="NTW">NTW</option>
              <option value="NTD">NTD</option>
            </select>
          </div>
        </div>


        <div class="info">
          <div class="label">Supporting Document</div>
          <div class="value" id="detail_docs"></div>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:18px;">
        <div id="savedMsg" style="margin-right:auto;color:#4cd964;font-weight:600;opacity:0;transition:opacity .2s;">
          Status updated!</div>
        <button class="btn" id="cancelCaseBtn">Close</button>
        <button class="btn save" id="saveCaseBtn" style="display:none;">Save</button>
      </div>
    </div>
  </div>
  </select>
  </div>
  </div>
  </div>

  <div style="display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:18px;">
    <div id="savedMsg" style="margin-right:auto;color:#4cd964;font-weight:600;opacity:0;transition:opacity .2s;">Status
      updated!</div>
    <button class="btn" id="cancelCaseBtn">Close</button>
    <button class="btn save" id="saveCaseBtn" style="display:none;">Save</button>
  </div>
  </div>
  </div>

  <div id="empModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="empModalTitle">
      <button class="closeBtn" id="closeEmpModal" aria-label="Close modal">&times;</button>

      <h2 id="empModalTitle">Employee Profile</h2>

      <div class="employee-profile">
        <img id="empPhoto" class="photo" src="" alt="Employee photo" />
      </div>

      <div class="employee-grid">
        <section aria-label="Personal Information">
          <div class="profile-row">
            <div class="profile-label">Name</div>
            <div class="profile-value" id="emp_name_english"></div>
          </div>
          <div class="profile-row">
            <div class="profile-label">Position</div>
            <div class="profile-value" id="emp_position"></div>
          </div>
          <div class="profile-row">
            <div class="profile-label">Sex</div>
            <div class="profile-value" id="emp_sex"></div>
          </div>
          <div class="profile-row">
            <div class="profile-label">Blood Type</div>
            <div class="profile-value" id="emp_blood_type"></div>
          </div>
          <div class="profile-row">
            <div class="profile-label">DOB</div>
            <div class="profile-value" id="emp_dob"></div>
          </div>
          <div class="profile-row">
            <div class="profile-label">Height</div>
            <div class="profile-value" id="emp_height"></div>
          </div>
        </section>

        <section aria-label="Contact & Education">
          <div class="profile-row">
            <div class="profile-label">Weight</div>
            <div class="profile-value" id="emp_weight"></div>
          </div>
          <div class="profile-row">
            <div class="profile-label">ID No.</div>
            <div class="profile-value" id="emp_id_card"></div>
          </div>
          <div class="profile-row">
            <div class="profile-label">Email</div>
            <div class="profile-value" id="emp_email"></div>
          </div>
          <div class="profile-row">
            <div class="profile-label">Mobile</div>
            <div class="profile-value" id="emp_mobile"></div>
          </div>
        </section>

        <section aria-label="Address & Metadata">
          <div class="profile-row">
            <div class="profile-label">Created At</div>
            <div class="profile-value" id="emp_created_at"></div>
          </div>
          <div class="profile-row">
            <div class="profile-label">SSS Number</div>
            <div class="profile-value" id="emp_sss"></div>
          </div>
          <div class="profile-row">
            <div class="profile-label">PhilHealth Number</div>
            <div class="profile-value" id="emp_philhealth"></div>
          </div>
          <div class="profile-row">
            <div class="profile-label">Pag-IBIG Number</div>
            <div class="profile-value" id="emp_pagibig"></div>
          </div>
        </section>
      </div>

    </div>
  </div>


  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>

    const SUPABASE_URL = "https://hzafznqoyinfjbqrrerp.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6YWZ6bnFveWluZmpicXJyZXJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDYzMzcsImV4cCI6MjA3NjA4MjMzN30.qQFFQ6fzqBXxl63JG4JWNZ0JR0ZVnoyiU65J4VlDNG8";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


    const loader = document.getElementById("loader");
    const loaderTxt = document.getElementById("loaderTxt");


    const caseTbody = document.getElementById("caseTbody");
    const caseForm = document.getElementById("caseForm");

    const caseModal = document.getElementById("caseModal");
    const closeCaseModal = document.getElementById("closeCaseModal");
    const cancelCaseBtn = document.getElementById("cancelCaseBtn");
    const saveCaseBtn = document.getElementById("saveCaseBtn");
    const savedMsg = document.getElementById("savedMsg");
    const detail_case_name = document.getElementById("detail_case_name");
    const detail_area = document.getElementById("detail_area");
    const detail_employees = document.getElementById("detail_employees");
    const detail_officer = document.getElementById("detail_officer");
    const detail_STATUS = document.getElementById("detail_STATUS");


    const dbTbody = document.getElementById("dbTbody");
    const empSearch = document.getElementById("empSearch");
    const empModal = document.getElementById("empModal");
    const closeEmpModal = document.getElementById("closeEmpModal");

    const empPhoto = document.getElementById("empPhoto");
    const emp_name_english = document.getElementById("emp_name_english");
    const emp_position = document.getElementById("emp_position");
    const emp_sex = document.getElementById("emp_sex");
    const emp_blood_type = document.getElementById("emp_blood_type");
    const emp_dob = document.getElementById("emp_dob");
    const emp_height = document.getElementById("emp_height");
    const emp_weight = document.getElementById("emp_weight");
    const emp_id_card = document.getElementById("emp_id_card");
    const emp_email = document.getElementById("emp_email");
    const emp_mobile = document.getElementById("emp_mobile");
    const emp_qq_msn = document.getElementById("emp_qq_msn");
    const emp_created_at = document.getElementById("emp_created_at");
    const emp_sss = document.getElementById("emp_sss");
    const emp_philhealth = document.getElementById("emp_philhealth");
    const emp_pagibig = document.getElementById("emp_pagibig");

    const burgerBtn = document.getElementById("burgerBtn");
    const sidebar = document.querySelector(".sidebar");

    burgerBtn.addEventListener("click", () => {
      burgerBtn.classList.toggle("active");
      sidebar.classList.toggle("open");
    });


    const filesGrid = document.getElementById("filesGrid");
    const filesCount = document.getElementById("filesCount");
    const fileSearch = document.getElementById("fileSearch");


    let currentCase = null;
    let originalStatus = null;
    let employeesCache = [];
    let filesCache = [];

    const FILE_BUCKET = "employee_201files";


    if (sessionStorage.getItem("role") !== "er") {

    }


    const tabBtns = document.querySelectorAll(".tab-btn");
    const contents = document.querySelectorAll(".tab-content");
    tabBtns.forEach(btn => btn.onclick = () => {
      tabBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      contents.forEach(c => c.classList.remove("active"));
      document.getElementById(btn.dataset.tab).classList.add("active");
    });


    document.getElementById("logoutBtn").onclick = () => {
      loaderTxt.textContent = "Logging out...";
      loader.classList.add("active");
      setTimeout(() => {
        sessionStorage.clear();
        window.location.href = "index.html";
      }, 700);
    };


    function escapeHtml(str) {
      if (str === null || str === undefined) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }


    async function loadCases() {
      loaderTxt.textContent = "Loading cases...";
      loader.classList.add("active");
      try {
        const { data, error } = await supabaseClient
          .from("cases")
          .select("*")
          .order("id", { ascending: false });

        loader.classList.remove("active");

        if (error) {
          console.error("Error loading cases:", error);
          caseTbody.innerHTML = `<tr><td colspan="5">Error loading data.</td></tr>`;
          return;
        }

        if (!data || data.length === 0) {
          caseTbody.innerHTML = `<tr><td colspan="5">No cases found.</td></tr>`;
          return;
        }

        caseTbody.innerHTML = "";
        data.forEach(row => {
          const tr = document.createElement("tr");


          tr.innerHTML = `
  <td>${escapeHtml(row.transcode ?? "")}</td>
  <td>${escapeHtml(row.case_name ?? "")}</td>
  <td>${escapeHtml(row.area ?? "")}</td>
  <td>${escapeHtml(row.status ?? "OPEN")}</td>
  <td>${escapeHtml(row.notes ?? "")}</td>
  <td><button class="view-btn btn">View</button></td>
`;


          tr.querySelector(".view-btn").addEventListener("click", (e) => {
            e.stopPropagation();
            openCaseModal(row);
          });

          caseTbody.appendChild(tr);
        });

      } catch (err) {
        loader.classList.remove("active");
        console.error(err);
        caseTbody.innerHTML = `<tr><td colspan="5">Error loading data.</td></tr>`;
      }
    }

    function openCaseModal(row) {
      currentCase = row;
      originalStatus = (row.status ?? "OPEN");

      detail_case_name.textContent = row.case_name ?? row.CASE_NAME ?? "";
      detail_area.textContent = row.area ?? row.AREA ?? "";
      detail_employees.textContent = row.employees ?? row.EMPLOYEES ?? "";
      detail_officer.textContent = row.officer ?? row.OFFICER ?? "";

      const cur = String(originalStatus).toUpperCase();
      detail_STATUS.value = ["IR", "OPEN", "NTE", "AH", "NTW", "NTD"].includes(cur) ? cur : "OPEN";


      const docsContainer = document.getElementById("detail_docs");
      const docsUrl = row.supporting_docs ?? row.supporting_docs_url ?? "";

      if (docsUrl) {
        const fileName = docsUrl.split("/").pop() || "file";
        const decodedName = decodeURIComponent(fileName); // turn %20 into spaces
        const shortName = decodedName.replace(/^\d+_/, ""); // remove timestamp

        docsContainer.innerHTML = `
    <a href="${escapeHtml(docsUrl)}" download target="_blank"
       style="color:#4da3ff;text-decoration:none;">
       ðŸ“Ž ${escapeHtml(shortName)}
    </a>
  `;
      } else {
        docsContainer.textContent = "No file uploaded.";
      }



      // hide save + saved status
      saveCaseBtn.style.display = "none";
      savedMsg.style.opacity = 0;

      caseModal.style.display = "flex";
      caseModal.setAttribute("aria-hidden", "false");
    }


    // Save button visibility when user changes status
    detail_STATUS.addEventListener("change", () => {
      const newVal = detail_STATUS.value;
      if (!originalStatus) originalStatus = (currentCase?.status ?? currentCase?.status ?? "OPEN");
      if (String(newVal).toUpperCase() !== String(originalStatus).toUpperCase()) {
        saveCaseBtn.style.display = "inline-block";
      } else {
        saveCaseBtn.style.display = "none";
      }
    });

    saveCaseBtn.addEventListener("click", async () => {
      if (!currentCase?.id) {
        alert("No case selected.");
        return;
      }

      const newStatus = detail_STATUS.value;

      loaderTxt.textContent = "Saving status...";
      loader.classList.add("active");

      const { data, error } = await supabaseClient
        .from("cases")
        .update({ status: newStatus })  // âœ… correct lowercase field
        .eq("id", currentCase.id);

      loader.classList.remove("active");

      if (error) {
        console.error("Error saving status:", error);
        alert("Error saving status. Check console for details.");
        return;
      }

      // locally update the current case
      currentCase.status = newStatus;
      originalStatus = newStatus;

      // hide save button + show confirmation
      saveCaseBtn.style.display = "none";
      savedMsg.style.opacity = 1;
      setTimeout(() => (savedMsg.style.opacity = 0), 1500);

      await loadCases(); // refresh your table
    });


    // Close case modal
    closeCaseModal.onclick = closeCaseModalFn;
    cancelCaseBtn.onclick = closeCaseModalFn;
    function closeCaseModalFn() {
      caseModal.style.display = "none";
      caseModal.setAttribute("aria-hidden", "true");
      currentCase = null;
      originalStatus = null;
    }

    // Add case
    caseForm.onsubmit = async (e) => {
      e.preventDefault();
      loaderTxt.textContent = "Uploading case...";
      loader.classList.add("active");

      const fileInput = document.getElementById("case_file");
      const notes = document.getElementById("case_notes").value.trim();
      const file = fileInput.files[0];

      let uploadedPath = "";

      try {
        // Upload supporting document if provided
        if (file) {
          const fileName = `${Date.now()}_${file.name}`;
          const { data, error } = await supabaseClient.storage
            .from("cases")
            .upload(fileName, file);

          if (error) throw error;

          // Get public URL for the uploaded file
          const { data: urlData } = supabaseClient.storage
            .from("cases")
            .getPublicUrl(fileName);
          uploadedPath = urlData.publicUrl;
        }

        // Prepare new case record
        const newCase = {
          transcode: generateTranscode(), // ðŸ‘ˆ ADD THIS
          case_name: document.getElementById("case_name").value,
          area: document.getElementById("case_area").value,
          employees: document.getElementById("case_employees").value,
          officer: document.getElementById("case_officer").value,
          status: "OPEN",
          notes: notes,
          supporting_docs: uploadedPath
        };

        // Save to Supabase
        const { error } = await supabaseClient.from("cases").insert([newCase]);
        loader.classList.remove("active");

        if (error) {
          console.error("Insert error:", error);
          alert("Error adding case: " + error.message);
          return;
        }

        // Reset form and refresh
        caseForm.reset();
        await loadCases();
      } catch (err) {
        loader.classList.remove("active");
        console.error(err);
        alert("Error uploading or saving case. Check console.");
      }
    };


    /* ===== EMPLOYEES: load, render, modal ===== */
    async function loadEmployees() {
      loaderTxt.textContent = "Loading employees...";
      loader.classList.add("active");
      try {
        const { data, error } = await supabaseClient
          .from("employees")
          .select("*")
          .order("id", { ascending: false });

        loader.classList.remove("active");

        if (error) {
          console.error("Error loading employees:", error);
          dbTbody.innerHTML = `<tr><td colspan="5">Error loading data.</td></tr>`;
          return;
        }

        if (!data || data.length === 0) {
          dbTbody.innerHTML = `<tr><td colspan="5">No employees found.</td></tr>`;
          employeesCache = [];
          document.getElementById("empCount").textContent = "0 records";
          return;
        }

        employeesCache = data; // cache
        renderEmployeeRows(data);
        document.getElementById("empCount").textContent = `${data.length} records loaded.`;
      } catch (err) {
        loader.classList.remove("active");
        console.error(err);
        dbTbody.innerHTML = `<tr><td colspan="5">Error loading data.</td></tr>`;
      }
    }
    // =========================
    // Delete Case Functionality
    // =========================
    async function deleteCase(caseId) {
      const confirmDelete = confirm("Are you sure you want to delete this case? This cannot be undone.");
      if (!confirmDelete) return;

      try {
        // Delete related files first
        const { error: fileError } = await supabase
          .from("cases")
          .delete()
          .eq("case_id", caseId);

        if (fileError) throw fileError;

        // Delete the case itself
        const { error: caseError } = await supabase
          .from("cases")
          .delete()
          .eq("id", caseId);

        if (caseError) throw caseError;

        alert("Case deleted successfully!");
        await loadCases(); // refresh list
      } catch (err) {
        console.error("Error deleting case:", err);
        alert("Failed to delete the case. Check console for details.");
      }
    }
    function renderEmployeeRows(list) {
      dbTbody.innerHTML = "";
      list.forEach(row => {
        const name = row.name_english ?? "";
        const position = row.position ?? "";
        const email = row.email ?? "";
        const mobile = row.mobile ?? "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(name)}</td>
          <td>${escapeHtml(position)}</td>
          <td>${escapeHtml(email)}</td>
          <td>${escapeHtml(mobile)}</td>
          <td>
            <button class="btn viewBtn" data-id="${row.id}" style="background:#0a84ff;color:#fff;margin-right:6px;">View</button>
            <button class="btn delBtn" data-id="${row.id}" style="background:#ff3b30;color:#fff;">Delete</button>
          </td>
        `;

        // view modal on click
        tr.querySelector(".viewBtn").onclick = (e) => {
          e.stopPropagation();
          openEmpModal(row);
        };

        // delete record on click
        tr.querySelector(".delBtn").onclick = async (e) => {
          e.stopPropagation();
          const confirmDel = confirm(`Are you sure you want to delete "${name}"?`);
          if (!confirmDel) return;
          await deleteEmployee(row.id);
        };

        dbTbody.appendChild(tr);
      });
    }

    async function deleteEmployee(id) {
      loaderTxt.textContent = "Deleting employee...";
      loader.classList.add("active");
      try {
        const { error } = await supabaseClient.from("employees").delete().eq("id", id);
        loader.classList.remove("active");
        if (error) {
          console.error("Delete error:", error);
          alert("Error deleting employee: " + error.message);
          return;
        }
        // refresh
        await loadEmployees();
      } catch (err) {
        loader.classList.remove("active");
        console.error(err);
        alert("Error deleting employee. Check console.");
      }
    }

    // Search employees (local filter)
    empSearch.addEventListener("input", (e) => {
      const q = (e.target.value || "").trim().toLowerCase();
      if (!q) {
        renderEmployeeRows(employeesCache);
        return;
      }
      const filtered = employeesCache.filter(r => {
        return (String(r.name_english || "") + " " + String(r.position || "") + " " + String(r.email || "") + " " + String(r.mobile || "")).toLowerCase().includes(q);
      });
      renderEmployeeRows(filtered);
    });

    // Open employee modal
    function openEmpModal(row) {
      // photo
      const photo = row.photo_url ?? row.photo ?? "";
      empPhoto.src = photo || "https://via.placeholder.com/300x300?text=No+Photo";
      empPhoto.alt = (row.name_english || "Employee");

      // fill fields (use lower-case names as your schema)
      emp_name_english.textContent = row.name_english ?? "";
      emp_position.textContent = row.position ?? "";
      emp_sex.textContent = row.sex ?? "";
      emp_blood_type.textContent = row.blood_type ?? "";
      emp_dob.textContent = row.dob ? new Date(row.dob).toLocaleDateString() : "";
      emp_height.textContent = row.height ?? "";
      emp_weight.textContent = row.weight ?? "";
      emp_id_card.textContent = row.id_card ?? "";
      emp_email.textContent = row.email ?? "";
      emp_mobile.textContent = row.mobile ?? "";
      emp_created_at.textContent = row.created_at ? new Date(row.created_at).toLocaleString() : "";
      emp_sss.textContent = row.sss ?? "";
      emp_philhealth.textContent = row.philhealth ?? "";
      emp_pagibig.textContent = row.pagibig ?? "";


      empModal.style.display = "flex";
      empModal.setAttribute("aria-hidden", "false");
    }

    // Close employee modal
    closeEmpModal.onclick = closeEmp;
    function closeEmp() {
      empModal.style.display = "none";
      empModal.setAttribute("aria-hidden", "true");
    }

    /* ===== FILES: list, render, preview, download, delete ===== */

    // returns a public URL for a file path in the bucket
    function getPublicUrlFor(path) {
      try {
        const { data } = supabaseClient.storage.from(FILE_BUCKET).getPublicUrl(path);
        // v2 returns object { publicUrl } or { data: { publicUrl } } depending on SDK version
        if (data && data.publicUrl) return data.publicUrl;
        if (data && data?.publicURL) return data.publicURL;
        // older returns { publicUrl: '...' } directly
        return (data && data.publicUrl) || "";
      } catch (err) {
        console.warn("getPublicUrlFor error (SDK differences):", err);
        // fallback: attempt property on return value
        try {
          const res = supabaseClient.storage.from(FILE_BUCKET).getPublicUrl(path);
          return res?.data?.publicUrl || res?.publicUrl || "";
        } catch (e) {
          return "";
        }
      }
    }

    // determine if file is image based on extension
    function isImageFile(name) {
      return /\.(jpe?g|png|gif|webp|bmp|svg)$/i.test(name);
    }

    async function loadFiles() {
      loaderTxt.textContent = "Loading files...";
      loader.classList.add("active");
      filesGrid.innerHTML = "";
      filesCount.textContent = "Loading files...";
      try {
        // NOTE: .list('', { limit: 1000 }) is for supabase-js v2. If you use v1 adjust accordingly.
        const res = await supabaseClient.storage.from(FILE_BUCKET).list("", { limit: 1000, offset: 0 });
        // res shape varies; try to detect:
        const data = res.data ?? res;
        const error = res.error ?? res?.error ?? null;

        loader.classList.remove("active");
        if (error) {
          console.error("Error listing files:", error);
          filesGrid.innerHTML = `<div class="muted">Error loading files: ${escapeHtml(error.message || String(error))}</div>`;
          filesCount.textContent = "Error";
          return;
        }

        if (!data || data.length === 0) {
          filesGrid.innerHTML = `<div class="muted">No files found in bucket "${FILE_BUCKET}".</div>`;
          filesCount.textContent = "0 files";
          filesCache = [];
          return;
        }

        // keep cache & simple limit (we expect exactly 201)
        filesCache = data.slice(0, 1000);
        filesCount.textContent = `${filesCache.length} files`;

        renderFiles(filesCache);
      } catch (err) {
        loader.classList.remove("active");
        console.error(err);
        filesGrid.innerHTML = `<div class="muted">Error loading files. Check console.</div>`;
        filesCount.textContent = "Error";
      }
    }

    // Render cards
    async function renderFiles(list) {
      filesGrid.innerHTML = "";
      for (const f of list) {
        // f has { name, id, updated_at, created_at, metadata, size } depending on SDK
        const filename = f.name ?? f.filename ?? f.path ?? String(f);
        const size = f.size ?? f.file_size ?? "";
        const updated = f.updated_at ?? f.last_modified ?? "";
        const path = filename; // assuming root listing returns name as path

        // attempt to get public url
        let publicUrl = "";
        try {
          const publicRes = supabaseClient.storage.from(FILE_BUCKET).getPublicUrl(path);
          // v2 returns { data: { publicUrl } }
          publicUrl = publicRes?.data?.publicUrl ?? publicRes?.publicURL ?? publicRes?.publicUrl ?? "";
        } catch (e) {
          publicUrl = "";
        }

        // if not public URL, create one via signed URL for preview (if allowed)
        let previewUrl = publicUrl;
        if (!previewUrl) {
          try {
            const signed = await supabaseClient.storage.from(FILE_BUCKET).createSignedUrl(path, 60); // expires in 60s
            previewUrl = signed?.data?.signedUrl ?? "";
          } catch (e) {
            previewUrl = "";
          }
        }

        const card = document.createElement("div");
        card.className = "file-card";

        const thumb = document.createElement("div");
        thumb.className = "file-thumb";
        if (isImageFile(filename) && previewUrl) {
          const img = document.createElement("img");
          img.src = previewUrl;
          img.alt = filename;
          img.className = "file-thumb";
          img.style.width = "100%";
          img.style.height = "110px";
          img.style.borderRadius = "8px";
          thumb.innerHTML = "";
          thumb.appendChild(img);
        } else {
          // show icon + ext
          const ext = filename.split('.').pop() || 'file';
          thumb.innerHTML = `<div style="text-align:center;padding:12px;"><div style="font-size:22px;color:#9b9b9b;">ðŸ“„</div><div class="muted">${escapeHtml(ext.toUpperCase())}</div></div>`;
        }

        const meta = document.createElement("div");
        meta.className = "file-meta";
        const nameDiv = document.createElement("div");
        nameDiv.className = "file-name";
        nameDiv.title = filename;
        nameDiv.textContent = filename;
        const sizeDiv = document.createElement("div");
        sizeDiv.className = "muted";
        sizeDiv.textContent = size ? `${Math.round(size / 1024)} KB` : "";
        meta.appendChild(nameDiv);
        meta.appendChild(sizeDiv);

        const actions = document.createElement("div");
        actions.className = "file-actions";

        // preview (open in new tab)
        const previewBtn = document.createElement("button");
        previewBtn.className = "btn";
        previewBtn.textContent = "Preview";
        previewBtn.style.background = "#0a84ff";
        previewBtn.style.color = "#fff";
        previewBtn.onclick = (e) => {
          e.stopPropagation();
          // open public or signed URL in new tab
          const urlToOpen = previewUrl || publicUrl;
          if (!urlToOpen) {
            alert("No public/signed URL available for this file.");
            return;
          }
          window.open(urlToOpen, "_blank");
        };

        // download
        const downloadBtn = document.createElement("button");
        downloadBtn.className = "btn";
        downloadBtn.textContent = "Download";
        downloadBtn.style.background = "#4cd964";
        downloadBtn.style.color = "#0a0a0a";
        downloadBtn.onclick = async (e) => {
          e.stopPropagation();
          try {
            // try public url first
            const url = publicUrl || (await supabaseClient.storage.from(FILE_BUCKET).createSignedUrl(path, 120))?.data?.signedUrl;
            if (!url) {
              alert("Unable to get download URL.");
              return;
            }
            // open url to download
            window.open(url, "_blank");
          } catch (err) {
            console.error(err);
            alert("Error preparing download.");
          }
        };

        // delete (requires permission)
        const delBtn = document.createElement("button");
        delBtn.className = "btn";
        delBtn.textContent = "Delete";
        delBtn.style.background = "#ff3b30";
        delBtn.style.color = "#fff";
        delBtn.onclick = async (e) => {
          e.stopPropagation();
          const ok = confirm(`Delete "${filename}" from bucket "${FILE_BUCKET}"? This is irreversible.`);
          if (!ok) return;
          loaderTxt.textContent = "Deleting file...";
          loader.classList.add("active");
          try {
            const { data, error } = await supabaseClient.storage.from(FILE_BUCKET).remove([path]);
            loader.classList.remove("active");
            if (error) {
              console.error("Error deleting file:", error);
              alert("Error deleting file: " + (error.message || error));
              return;
            }
            // remove from cache & re-render
            filesCache = filesCache.filter(x => (x.name ?? x.path ?? x) !== filename);
            renderFiles(filesCache);
            filesCount.textContent = `${filesCache.length} files`;
          } catch (err) {
            loader.classList.remove("active");
            console.error(err);
            alert("Error deleting file. Check console.");
          }
        };

        actions.appendChild(previewBtn);
        actions.appendChild(downloadBtn);
        // show delete only if allowed (we show it, but it will fail if permissions insufficient)
        actions.appendChild(delBtn);

        card.appendChild(thumb);
        card.appendChild(meta);
        card.appendChild(actions);

        filesGrid.appendChild(card);
      }
    }

    // Search files
    fileSearch.addEventListener("input", (e) => {
      const q = (e.target.value || "").trim().toLowerCase();
      if (!q) {
        renderFiles(filesCache);
        return;
      }
      const filtered = filesCache.filter(f => {
        const name = (f.name ?? f.filename ?? f.path ?? String(f)).toLowerCase();
        return name.includes(q);
      });
      renderFiles(filtered);
      filesCount.textContent = `${filtered.length} files (filtered)`;
    });

    /* ===== INIT ===== */
    // load both datasets initially
    loadCases();
    loadEmployees();
    loadFiles();

    /* ===== expose console helpers (optional) ===== */
    window._reloadEmployees = loadEmployees;
    window._reloadCases = loadCases;
    window._reloadFiles = loadFiles;

    function generateTranscode() {
      const date = new Date();
      const ymd = date.toISOString().slice(0, 10).replace(/-/g, "");
      const rand = Math.random().toString(16).slice(2, 8).toUpperCase();
      return `ER-${ymd}-${rand}`;
    }

  </script>
</body>

</html>